// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Пользователь Telegram.
model User {
  /// Telegram ID пользователя.
  id           String    @id
  username     String?
  firstName    String?
  lastName     String?
  languageCode String?
  avatarUrl    String?
  timezone     String?
  email        String?
  isAdmin      Boolean   @default(false)
  lastSeenAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  enrollments     CourseEnrollment[]
  progresses      CourseProgress[]
  reminderSetting ReminderSetting?
  reviews         CourseReview[]
  testAttempts    TestAttempt[]
  formAttempts    FormAttempt[]
  activityLogs    ActivityLog[]      @relation("UserActivityLogs")
  redeemedCodes   CourseAccessCode[] @relation("UserRedeemedCodes")
}

/// Образовательный курс.
model Course {
  id               String         @id @default(cuid())
  slug             String         @unique
  title            String
  shortDescription String?
  description      String?
  coverImageUrl    String?
  promoVideoUrl    String?
  category         CourseCategory
  language         CourseLanguage @default(SR)
  level            CourseLevel    @default(BEGINNER)
  priceAmount      Int            @default(0)
  priceCurrency    Currency       @default(EUR)
  isFree           Boolean        @default(false)
  isPublished      Boolean        @default(false)
  publishedAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  createdById      String?
  updatedById      String?

  modules      CourseModule[]
  enrollments  CourseEnrollment[]
  reviews      CourseReview[]
  tests        CourseTest[]
  forms        CourseForm[]
  activityLogs ActivityLog[]
  accessCodes  CourseAccessCode[]

  @@index([category])
  @@index([isPublished])
}

/// Модуль курса.
model CourseModule {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]
  unlockTests CourseTest[] @relation("ModuleUnlockTests")
  unlockForms CourseForm[] @relation("ModuleUnlockForms")

  @@index([courseId, order])
}

/// Урок внутри модуля.
model Lesson {
  id              String            @id @default(cuid())
  moduleId        String
  title           String
  summary         String?
  content         Json?
  contentType     LessonContentType @default(TEXT)
  videoUrl        String?
  durationMinutes Int?
  order           Int
  isPreview       Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  module      CourseModule       @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  attachments LessonAttachment[]
  progresses  CourseProgress[]
  unlockTests CourseTest[]       @relation("LessonUnlockTests")
  unlockForms CourseForm[]       @relation("LessonUnlockForms")
  forms       CourseForm[]       @relation("LessonForms")

  @@index([moduleId, order])
}

/// Дополнительные материалы к уроку.
model LessonAttachment {
  id        String               @id @default(cuid())
  lessonId  String
  title     String
  url       String
  type      LessonAttachmentType @default(RESOURCE)
  createdAt DateTime             @default(now())

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
}

/// Подписка / покупка курса.
model CourseEnrollment {
  id            String             @id @default(cuid())
  userId        String
  courseId      String
  status        CourseAccessStatus @default(ACTIVE)
  accessType    CourseAccessType   @default(PURCHASED)
  paymentId     String?
  paymentStatus PaymentStatus?
  pricePaid     Int?
  priceCurrency Currency?
  expiresAt     DateTime?
  activatedAt   DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
}

model CourseAccessCode {
  id             String                  @id @default(cuid())
  code           String                  @unique
  courseId       String
  status         CourseAccessCodeStatus  @default(AVAILABLE)
  note           String?
  createdBy      String?
  createdAt      DateTime                @default(now())
  activatedAt    DateTime?
  activatedById  String?

  course         Course                  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  activatedBy    User?                   @relation("UserRedeemedCodes", fields: [activatedById], references: [id])

  @@index([courseId])
}

/// Прогресс пользователя по урокам.
model CourseProgress {
  id              String               @id @default(cuid())
  userId          String
  lessonId        String
  status          LessonProgressStatus @default(IN_PROGRESS)
  progressPercent Int                  @default(0)
  startedAt       DateTime?
  completedAt     DateTime?
  lastViewedAt    DateTime?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

/// Настройки напоминаний.
model ReminderSetting {
  id        String            @id @default(cuid())
  userId    String            @unique
  frequency ReminderFrequency @default(DAILY)
  timeOfDay ReminderTimeOfDay @default(MORNING)
  isEnabled Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// Отзывы на курс.
model CourseReview {
  id        String       @id @default(cuid())
  courseId  String
  userId    String
  rating    Int
  title     String?
  content   String?
  status    ReviewStatus @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@index([courseId, status])
}

/// Тесты / квизы в конце курсов.
model CourseTest {
  id          String   @id @default(cuid())
  courseId    String
  title       String
  description String?
  questions   Json
  unlockModuleId String?
  unlockLessonId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course   Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  attempts TestAttempt[]
  unlockModule CourseModule? @relation("ModuleUnlockTests", fields: [unlockModuleId], references: [id])
  unlockLesson Lesson?       @relation("LessonUnlockTests", fields: [unlockLessonId], references: [id])
}

/// Попытки прохождения теста.
model TestAttempt {
  id          String            @id @default(cuid())
  testId      String
  userId      String
  score       Int?
  maxScore    Int?
  status      TestAttemptStatus @default(IN_PROGRESS)
  responses   Json?
  startedAt   DateTime          @default(now())
  completedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  test CourseTest @relation(fields: [testId], references: [id], onDelete: Cascade)
  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// Формы / опросники в курсах (с результатами на основе выбора вариантов или оценок).
model CourseForm {
  id          String   @id @default(cuid())
  courseId    String
  lessonId    String?  // Если указан, форма принадлежит конкретному уроку
  title       String
  description String?
  type        FormType @default(CHOICE) // Тип формы: CHOICE (выбор вариантов) или RATING (оценка)
  maxRating   Int?     // Максимальная оценка для рейтинговых форм (по умолчанию 5)
  questions   Json     // Вопросы с вариантами ответов (CHOICE) или только текст (RATING)
  results     Json     // Результаты с условиями (CHOICE) или диапазонами баллов (RATING)
  unlockModuleId String?
  unlockLessonId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  course   Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson   Lesson?       @relation("LessonForms", fields: [lessonId], references: [id], onDelete: Cascade)
  attempts FormAttempt[]
  unlockModule CourseModule? @relation("ModuleUnlockForms", fields: [unlockModuleId], references: [id])
  unlockLesson Lesson?       @relation("LessonUnlockForms", fields: [unlockLessonId], references: [id])
}

/// Попытки прохождения формы.
model FormAttempt {
  id          String            @id @default(cuid())
  formId      String
  userId      String
  responses   Json?             // Выбранные ответы пользователя
  resultId    String?           // ID результата, который получил пользователь
  status      FormAttemptStatus @default(IN_PROGRESS)
  startedAt   DateTime          @default(now())
  completedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  form CourseForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([formId, userId])
}

/// Лог активности (для аналитики и аудита).
model ActivityLog {
  id        String            @id @default(cuid())
  actorId   String?
  actorType ActivityActorType @default(SYSTEM)
  action    String
  metadata  Json?
  createdAt DateTime          @default(now())

  user     User?   @relation("UserActivityLogs", fields: [actorId], references: [id])
  courseId String?
  course   Course? @relation(fields: [courseId], references: [id])
}

enum CourseCategory {
  EROS_EVERY_DAY
  MEN_WOMEN
  PSYCHOSEXUALITY
}

enum CourseLanguage {
  SR
  RU
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum LessonContentType {
  TEXT
  VIDEO
  AUDIO
  LIVE
  QUIZ
}

enum LessonAttachmentType {
  RESOURCE
  VIDEO
  FILE
  LINK
}

enum Currency {
  EUR
  TELEGRAM_STAR
}

enum CourseAccessStatus {
  ACTIVE
  PENDING
  EXPIRED
  REFUNDED
  REVOKED
}

enum CourseAccessType {
  PURCHASED
  FREE
  GRANTED
}

enum CourseAccessCodeStatus {
  AVAILABLE
  REDEEMED
  REVOKED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum LessonProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum ReminderFrequency {
  NEVER
  DAILY
  WEEKLY
  MONTHLY
}

enum ReminderTimeOfDay {
  MORNING
  MIDDAY
  EVENING
}

enum ReviewStatus {
  PENDING
  PUBLISHED
  HIDDEN
}

enum TestAttemptStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum FormAttemptStatus {
  IN_PROGRESS
  COMPLETED
}

enum ActivityActorType {
  SYSTEM
  USER
  ADMIN
}

enum FormType {
  CHOICE
  RATING
}

