# Потенциальная проблема с хранением прогресса

## Статус
⚠️ **ВНИМАНИЕ**: Возможна проблема с сохранением или отображением прогресса прохождения курсов.

## История проблемы
- Дата обнаружения: Декабрь 2025
- Пользователь: 446207374
- Симптомы: Пользователь сообщил о сбросе прогресса курса

## Результаты диагностики (446207374)
- ✅ Enrollment существует и активен
- ✅ Прогресс есть в базе данных (1 урок, 60% прогресса)
- ✅ Логов сброса не найдено
- ⚠️ Возможная проблема на фронтенде или с синхронизацией

## Возможные причины
1. **Проблема с userId**: Неправильное определение userId на фронтенде
2. **Проблема с кэшированием**: Старые данные кэшируются
3. **Проблема с API**: Неправильная загрузка данных с сервера
4. **Проблема с синхронизацией**: Прогресс не сохраняется при обновлении
5. **CASCADE DELETE**: Автоматическое удаление при удалении уроков/курсов
6. **Проблема с транзакциями**: Прогресс не коммитится в БД

## Инструменты для диагностики

### Скрипт проверки прогресса
```bash
cd /opt/murmur/deploy
./check-progress-easy.sh <USER_ID>
```

### Проверка через API
```bash
curl https://api.murmurmne.com/users/<USER_ID>/enrollments
```

### Проверка в базе данных
```sql
-- Enrollment
SELECT * FROM "CourseEnrollment" WHERE "userId" = '<USER_ID>';

-- Прогресс
SELECT cp.*, l.title, c.title as course_title
FROM "CourseProgress" cp
JOIN "Lesson" l ON cp."lessonId" = l.id
JOIN "CourseModule" m ON l."moduleId" = m.id
JOIN "Course" c ON m."courseId" = c.id
WHERE cp."userId" = '<USER_ID>';

-- Логи сбросов
SELECT * FROM "ActivityLog" 
WHERE action = 'admin.progress.reset' 
AND "metadata"->>'userId' = '<USER_ID>';
```

## Что проверить при повторении проблемы

1. **Проверить данные в БД** (используя скрипт выше)
2. **Проверить userId на фронтенде**:
   ```javascript
   window.Telegram?.WebApp?.initDataUnsafe?.user?.id
   ```
3. **Проверить Network запросы** в DevTools
4. **Проверить логи backend** на наличие ошибок
5. **Проверить ActivityLog** на наличие сбросов

## Рекомендации для мониторинга

1. Добавить логирование всех операций с прогрессом
2. Добавить мониторинг количества "потерянных" прогрессов
3. Регулярно проверять целостность данных
4. Добавить алерты при неожиданных сбросах прогресса

## Связанные файлы
- `deploy/check-progress-easy.sh` - скрипт для проверки прогресса
- `deploy/check-progress.js` - Node.js скрипт для проверки
- `deploy/DIAGNOSE_PROGRESS_RESET.md` - подробная диагностика

## Дата последнего обновления
Декабрь 2025

